<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan IDPs Tracking</title>
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Enhanced legend styles */
    .legend {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      font-family: 'Arial', sans-serif;
      max-width: 220px;
      transition: all 0.3s ease;
    }
    
    .legend:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .legend-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    .legend-scale {
      margin-bottom: 10px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      transition: transform 0.2s;
    }
    
    .legend-item:hover {
      transform: translateX(3px);
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 12px;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .legend-label {
      font-size: 13px;
      color: #555;
    }
    
    .legend-note {
      font-size: 11px;
      color: #888;
      margin-top: 10px;
      font-style: italic;
    }
    
    .legend-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }
    
    .legend-toggle-text {
      font-size: 12px;
      color: #666;
    }
    
    .legend-toggle-icon {
      font-size: 14px;
      transition: transform 0.3s;
    }
    
    .legend.collapsed {
      padding: 10px 15px;
    }
    
    .legend.collapsed .legend-scale,
    .legend.collapsed .legend-note {
      display: none;
    }
    
    .legend.collapsed .legend-toggle-icon {
      transform: rotate(180deg);
    }
    
    /* Drilldown button styles */
    .drilldown-back {
      position: absolute;
      top: 60px;
      right: 20px;
      z-index: 1000;
      background: #418FDE;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      display: none;
    }
    
    .drilldown-back:hover {
      background: #3a7bc8;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }
    
    .drilldown-back:active {
      transform: translateY(0);
    }
    
    /* Map title styles */
    #map-title-3 {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-size: 18px;
      color: #333;
      text-align: center;
      max-width: 80%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>
  <!-- Map Container for Total Number of IDPs by State -->
  <div class="map-container">
    <h2 id="map-title-3">Total Number of IDPs by State</h2>
    <button id="drilldown-back" class="drilldown-back">← Back to States</button>
    <div id="map3" class="map"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configuration constants
      const MAP_CONFIG = {
        center: [16, 30],
        zoom: L.Browser.mobile ? 3 : 5.5,
        minZoom: 3,
        maxZoom: 18,
        padding: [50, 50]
      };

      const COLORS = {
        state: {
          fill: '#418FDE',
          stroke: '#fff'
        },
        district: {
          fill: '#41DE8F',
          stroke: '#fff'
        }
      };

      // Initialize the map
      const map3 = L.map('map3', {
        center: MAP_CONFIG.center,
        zoom: MAP_CONFIG.zoom,
        minZoom: MAP_CONFIG.minZoom,
        maxZoom: MAP_CONFIG.maxZoom
      });

      // Base layers configuration
      const BASE_LAYERS = {
        "Mapbox Custom": L.tileLayer(
          'https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
            attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            tileSize: 512,
            zoomOffset: -1
          }
        ),
        "CartoDB Light": L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }
        ),
        "OpenStreetMap": L.tileLayer(
          'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }
        ),
        "Esri World Imagery": L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
          }
        ),
        "Stamen Toner": L.tileLayer(
          'https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
          }
        )
      };

      // Add default base layer
      BASE_LAYERS["Mapbox Custom"].addTo(map3);
      
      // Add layer control
      L.control.layers(BASE_LAYERS).addTo(map3);

      // Layer groups for state and district markers
      const stateMarkersLayer = L.layerGroup();
      const districtMarkersLayer = L.layerGroup();
      let currentState = null;
      let currentDataRange = null;
      const drilldownBackBtn = document.getElementById('drilldown-back');

      // Initialize the map with state data
      function initializeMap() {
        loadStateData();
        setupEventListeners();
        addLegend();
        startAnimationLoop();
      }

      // Load state data from CSV
      function loadStateData() {
        Papa.parse('./data/total_idps.csv', {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (!results.data || results.data.length === 0) {
              console.error('No data found in CSV');
              return;
            }

            const geoJsonData = convertToGeoJSON(results.data);
            currentDataRange = calculateDataRange(results.data, 'total_idps');
            createStateMarkers(geoJsonData);
            updateLegend('state', currentDataRange);
          },
          error: (error) => {
            console.error('Error loading state data:', error);
            showError('Failed to load state data. Please try again.');
          }
        });
      }

      // Convert CSV data to GeoJSON format
      function convertToGeoJSON(data) {
        return {
          type: 'FeatureCollection',
          features: data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };
      }

      // Calculate data range for legend
      function calculateDataRange(data, field) {
        const values = data.map(item => item[field]);
        const min = Math.min(...values);
        const max = Math.max(...values);
        const mid = min + (max - min) / 2;
        
        return {
          min: min,
          mid: mid,
          max: max,
          field: field
        };
      }

      // Create state markers from GeoJSON data
      function createStateMarkers(geoJsonData) {
        const maxTotalIdps = currentDataRange.max;

        L.geoJSON(geoJsonData, {
          pointToLayer: (feature, latlng) => {
            const marker = createCircleMarker(
              latlng, 
              feature.properties.total_idps, 
              maxTotalIdps, 
              COLORS.state.fill,
              COLORS.state.stroke
            );

            // Add click handler for drill-down
            marker.on('click', () => handleStateClick(feature.properties.state));
            
            return marker;
          },
          onEachFeature: (feature, layer) => {
            addPopupAndTooltip(layer, feature.properties, 'state');
          }
        }).addTo(stateMarkersLayer);

        map3.addLayer(stateMarkersLayer);
      }

      // Create a circle marker with animation
      function createCircleMarker(latlng, value, maxValue, fillColor, strokeColor) {
        const baseRadius = 8 + (value / maxValue) * 20;
        
        const marker = L.circleMarker(latlng, {
          radius: baseRadius,
          fillColor: fillColor,
          color: strokeColor,
          weight: 1,
          opacity: 1,
          fillOpacity: 0.7
        });

        animateCircleMarker(marker, baseRadius);
        return marker;
      }

      // Animate a circle marker
      function animateCircleMarker(marker, baseRadius) {
        new TWEEN.Tween({ radius: baseRadius })
          .to({ radius: baseRadius * 1.5 }, 1000)
          .easing(TWEEN.Easing.Sinusoidal.InOut)
          .yoyo(true)
          .repeat(Infinity)
          .onUpdate(({ radius }) => marker.setRadius(radius))
          .start();
      }

      // Add popup and tooltip to a layer
      function addPopupAndTooltip(layer, properties, level) {
        if (level === 'state') {
          layer.bindPopup(`
            <div style="font-family: Arial, sans-serif; min-width: 200px;">
              <h3 style="margin: 0 0 10px 0; color: #418FDE;">${properties.state}</h3>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold;">Total IDPs:</span>
                <span>${properties.total_idps.toLocaleString()}</span>
              </div>
              <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #888;">
                <i class="fas fa-mouse-pointer"></i> Click to view districts
              </div>
            </div>
          `);

          layer.bindTooltip(`
            <div style="font-family: Arial, sans-serif;">
              <b>${properties.state}</b><br/>
              IDPs: ${properties.total_idps.toLocaleString()}
            </div>
          `);
        } else {
          layer.bindPopup(`
            <div style="font-family: Arial, sans-serif; min-width: 200px;">
              <h3 style="margin: 0 0 10px 0; color: #41DE8F;">${properties.district}</h3>
              <div style="display: flex; justify-content: space-between;">
                <span style="font-weight: bold;">Total IDPs:</span>
                <span>${properties.total_idps.toLocaleString()}</span>
              </div>
              <div style="margin-top: 5px; font-size: 12px; color: #888;">
                <i class="fas fa-map-marker-alt"></i> ${properties.state}
              </div>
            </div>
          `);

          layer.bindTooltip(`
            <div style="font-family: Arial, sans-serif;">
              <b>${properties.district}</b><br/>
              IDPs: ${properties.total_idps.toLocaleString()}
            </div>
          `);
        }
      }

      // Handle state click for drill-down
      function handleStateClick(stateName) {
        map3.removeLayer(stateMarkersLayer);
        loadDistrictData(stateName);
      }

      // Load district data for a state
      function loadDistrictData(stateName) {
        document.getElementById('map-title-3').textContent = `Loading districts for ${stateName}...`;
        
        Papa.parse('./data/districts_data.csv', {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (!results.data || results.data.length === 0) {
              showError('No district data found for this state');
              return;
            }

            const stateDistricts = results.data.filter(d => d.state === stateName);
            currentDataRange = calculateDataRange(stateDistricts, 'total_idps');
            createDistrictMarkers(stateDistricts, stateName);
            updateLegend('district', currentDataRange);
          },
          error: (error) => {
            console.error('Error loading district data:', error);
            showError('Failed to load district data. Please try again.');
            resetToStateView();
          }
        });
      }

      // Create district markers
      function createDistrictMarkers(districts, stateName) {
        districtMarkersLayer.clearLayers();
        const maxTotalIdps = currentDataRange.max;

        districts.forEach(district => {
          const marker = createCircleMarker(
            [district.lat, district.lon], 
            district.total_idps, 
            maxTotalIdps, 
            COLORS.district.fill,
            COLORS.district.stroke
          );

          addPopupAndTooltip(marker, district, 'district');
          districtMarkersLayer.addLayer(marker);
        });

        map3.addLayer(districtMarkersLayer);
        updateUIForDistrictView(stateName, districts);
        currentState = stateName;
      }

      // Update UI for district view
      function updateUIForDistrictView(stateName, districts) {
        document.getElementById('map-title-3').textContent = `IDPs by District in ${stateName}`;
        drilldownBackBtn.style.display = 'block';

        if (districts.length > 0) {
          const bounds = L.latLngBounds(districts.map(d => [d.lat, d.lon]));
          map3.fitBounds(bounds, { padding: MAP_CONFIG.padding });
        }
      }

      // Reset to state view
      function resetToStateView() {
        map3.removeLayer(districtMarkersLayer);
        map3.addLayer(stateMarkersLayer);
        map3.setView(MAP_CONFIG.center, MAP_CONFIG.zoom);
        document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
        drilldownBackBtn.style.display = 'none';
        currentState = null;
        updateLegend('state', currentDataRange);
      }

      // Show error message
      function showError(message) {
        console.error(message);
        // You could implement a more user-friendly error display here
        alert(message);
      }

      // Add legend to the map
      function addLegend() {
        const legend = L.control({ position: 'bottomright' });
        
        legend.onAdd = () => {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = `
            <div class="legend-title">IDPs by State</div>
            <div class="legend-scale">
              <div class="legend-item">
                <div class="legend-color" style="background: ${COLORS.state.fill}; width: 10px; height: 10px;"></div>
                <div class="legend-label">Loading data...</div>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: ${COLORS.state.fill}; width: 20px; height: 20px;"></div>
                <div class="legend-label">Loading data...</div>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: ${COLORS.state.fill}; width: 30px; height: 30px;"></div>
                <div class="legend-label">Loading data...</div>
              </div>
            </div>
            <div class="legend-note">Click on a state to view district-level data</div>
            <div class="legend-toggle">
              <span class="legend-toggle-text">Show details</span>
              <i class="fas fa-chevron-up legend-toggle-icon"></i>
            </div>
          `;
          
          // Add toggle functionality
          const toggle = div.querySelector('.legend-toggle');
          toggle.addEventListener('click', function() {
            div.classList.toggle('collapsed');
          });
          
          return div;
        };
        
        legend.addTo(map3);
        return legend;
      }

      // Update legend based on current view and data range
      function updateLegend(level, dataRange) {
        const legend = document.querySelector('.legend');
        if (!legend) return;
        
        const title = legend.querySelector('.legend-title');
        const note = legend.querySelector('.legend-note');
        const colorItems = legend.querySelectorAll('.legend-item');
        const colors = level === 'state' ? COLORS.state : COLORS.district;
        
        if (level === 'state') {
          title.textContent = 'IDPs by State';
          note.textContent = 'Click on a state to view district-level data';
        } else {
          title.textContent = 'IDPs by District';
          note.textContent = `Showing districts in ${currentState}`;
        }
        
        if (dataRange) {
          const minLabel = formatNumber(dataRange.min);
          const midLabel = formatNumber(dataRange.mid);
          const maxLabel = formatNumber(dataRange.max);
          
          colorItems[0].querySelector('.legend-label').textContent = `≤ ${midLabel}`;
          colorItems[1].querySelector('.legend-label').textContent = `${midLabel} - ${formatNumber(dataRange.max * 0.75)}`;
          colorItems[2].querySelector('.legend-label').textContent = `≥ ${formatNumber(dataRange.max * 0.75)}`;
          
          // Update colors
          colorItems.forEach(item => {
            const colorCircle = item.querySelector('.legend-color');
            colorCircle.style.background = colors.fill;
            colorCircle.style.borderColor = colors.stroke;
          });
        }
      }

      // Format numbers with commas
      function formatNumber(num) {
        return num.toLocaleString();
      }

      // Setup event listeners
      function setupEventListeners() {
        drilldownBackBtn.addEventListener('click', resetToStateView);
      }

      // Start Tween.js animation loop
      function startAnimationLoop() {
        function animate() {
          requestAnimationFrame(animate);
          TWEEN.update();
        }
        animate();
      }

      // Initialize the map
      initializeMap();
    });
  </script>
</body>
</html>
