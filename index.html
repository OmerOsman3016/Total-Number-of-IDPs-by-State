<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Remove duplicate Chart.js -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 
</head>

<body>
  

      <!-- Map Container for Total Number of IDPs by State -->
      <div class="map-container">
        <h2 id="map-title-3">Total Number of IDPs by State</h2>
        <button id="drilldown-back" class="drilldown-back">‚Üê Back to States</button>
        <div id="map3" class="map"></div>
      </div>
    </div>
    
   
  <script>
    
    // Initialize the third map
    const map3 = L.map('map3').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the third map
    const cartoDBLight3 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap3 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery3 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner3 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the third map
    mapboxCustom3.addTo(map3);

    // Add layer control to the third map
    const baseLayers3 = {
      "Mapbox Custom": mapboxCustom3,
      "CartoDB Light": cartoDBLight3,
      "OpenStreetMap": openStreetMap3,
      "Esri World Imagery": esriWorldImagery3,
      "Stamen Toner": stamenToner3
    };

    L.control.layers(baseLayers3).addTo(map3);

    // Variables for drill-down functionality
    let stateMarkersLayer = L.layerGroup();
    let districtMarkersLayer = L.layerGroup();
    let currentState = null;
    const drilldownBackBtn = document.getElementById('drilldown-back');

    // Function to load district data for a state
    function loadDistrictData(stateName) {
      // Show loading indicator
      document.getElementById('map-title-3').textContent = `Loading districts for ${stateName}...`;
      
      // In a real application, you would load district data from your server or CSV file
      // For this example, we'll use a mock data structure
      Papa.parse('./data/districts_data.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => {
          // Filter districts for the selected state
          const stateDistricts = results.data.filter(d => d.state === stateName);
          
          // Clear previous district markers
          districtMarkersLayer.clearLayers();
          
          // Find the maximum total_idps value for normalization
          const maxTotalIdps = Math.max(...stateDistricts.map(d => d.total_idps));
          
          // Add markers for each district
          stateDistricts.forEach(district => {
            const baseRadius = 8 + (district.total_idps / maxTotalIdps) * 20;
            
            const marker = L.circleMarker([district.lat, district.lon], {
              radius: baseRadius,
              fillColor: '#418FDE', // Different color for districts
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });
            
            // Add animation
            animateCircleMarker(marker, baseRadius);
            
            // Add popup
            marker.bindPopup(`
              <b>District:</b> ${district.district}<br/>
              <b>Total IDPs:</b> ${district.total_idps.toLocaleString()}
            `);
            
            // Add tooltip
            marker.bindTooltip(`
              <b>${district.district}</b><br/>
              <b>Total IDPs:</b> ${district.total_idps.toLocaleString()}
            `);
            
            // Add to district layer
            districtMarkersLayer.addLayer(marker);
          });
          
          // Add district layer to map
          map3.addLayer(districtMarkersLayer);
          
          // Update title
          document.getElementById('map-title-3').textContent = `IDPs by District in ${stateName}`;
          
          // Show back button
          drilldownBackBtn.style.display = 'block';
          
          // Store current state
          currentState = stateName;
          
          // Fit bounds to show all districts
          if (stateDistricts.length > 0) {
            const bounds = L.latLngBounds(stateDistricts.map(d => [d.lat, d.lon]));
            map3.fitBounds(bounds, { padding: [50, 50] });
          }
        },
        error: (error) => {
          console.error('Error loading district data:', error);
          alert('Failed to load district data. Please try again.');
          document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
        }
      });
    }

    // Back button functionality
    drilldownBackBtn.addEventListener('click', function() {
      // Remove district layer
      map3.removeLayer(districtMarkersLayer);
      
      // Add state layer back
      map3.addLayer(stateMarkersLayer);
      
      // Reset view
      map3.setView([16, 30], L.Browser.mobile ? 3 : 5.5);
      
      // Update title
      document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
      
      // Hide back button
      drilldownBackBtn.style.display = 'none';
      
      // Clear current state
      currentState = null;
    });

    // Parse CSV data and create animated markers for the third map
    Papa.parse('./data/total_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection3 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_idps value for normalization
        const maxTotalIdps = Math.max(...results.data.map(d => d.total_idps));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the third map
        L.geoJSON(geoJsonFeatureCollection3, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_idps value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_idps / maxTotalIdps) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: '#418FDE', // Blue color for IDPs
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            // Add click handler for drill-down
            marker.on('click', function(e) {
              // Remove state layer
              map3.removeLayer(stateMarkersLayer);
              
              // Load district data for this state
              loadDistrictData(feature.properties.state);
            });

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}<br/>
              <small>Click to view districts</small>
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(stateMarkersLayer);

        // Add state markers layer to map
        map3.addLayer(stateMarkersLayer);
      }
    });

    // Update Tween.js animations on each frame
    function animate() {
      requestAnimationFrame(animate);
      TWEEN.update();
    }
    animate(); // Start the animation loop

    // Add legend to the third map
    const legend3 = L.control({ position: 'bottomright' });
    legend3.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total IDPs by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">  < 500,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> 500,001 - 1,000,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> > 1,000,001 IDPs</span>
        </div>
        <div style="margin-top: 10px; font-size:12px; color: #666;">
          Click on a state to view district-level data
        </div>
      `;
      return div;
    };
    legend3.addTo(map3);
    
    
  </script>
</body>
</html>
 
