<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan IDPs Tracking</title>
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>

<body>
  <!-- Map Container for Total Number of IDPs by State -->
  <div class="map-container">
    <h2 id="map-title-3">Total Number of IDPs by State</h2>
    <button id="drilldown-back" class="drilldown-back">← Back to States</button>
    <div id="map3" class="map"></div>
  </div>

  <script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Configuration constants
      const MAP_CONFIG = {
  center: [16, 30],
  zoom: L.Browser.mobile ? 4 : 7,  // Lower numbers = more zoomed out
  minZoom: 5,  // Allows zooming out further
  maxZoom: 18,
  padding: [50, 50]
};

      const MARKER_STYLES = {
        state: {
          fillColor: '#418FDE',
          color: '#fff',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.7,
          baseRadius: 8,
          maxRadius: 28
        },
        district: {
          fillColor: '#41DE8F',
          color: '#fff',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.7,
          baseRadius: 8,
          maxRadius: 28
        }
      };

      // Initialize the map
      const map3 = L.map('map3', {
        center: MAP_CONFIG.center,
        zoom: MAP_CONFIG.zoom,
        minZoom: MAP_CONFIG.minZoom,
        maxZoom: MAP_CONFIG.maxZoom
      });

      // Base layers configuration
      const BASE_LAYERS = {
        "Mapbox Custom": L.tileLayer(
          'https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
            attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            tileSize: 512,
            zoomOffset: -1
          }
        ),
        "CartoDB Light": L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }
        ),
        "OpenStreetMap": L.tileLayer(
          'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }
        ),
        "Esri World Imagery": L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
          }
        ),
        "Stamen Toner": L.tileLayer(
          'https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
          }
        )
      };

      // Add default base layer
      BASE_LAYERS["Mapbox Custom"].addTo(map3);
      
      // Add layer control
      L.control.layers(BASE_LAYERS).addTo(map3);

      // Layer groups for state and district markers
      const stateMarkersLayer = L.layerGroup();
      const districtMarkersLayer = L.layerGroup();
      let currentState = null;
      const drilldownBackBtn = document.getElementById('drilldown-back');

      // Initialize the map with state data
      function initializeMap() {
        loadStateData();
        setupEventListeners();
        addLegend();
        startAnimationLoop();
      }

      // Load state data from CSV
      function loadStateData() {
        Papa.parse('./data/total_idps.csv', {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (!results.data || results.data.length === 0) {
              console.error('No data found in CSV');
              return;
            }

            const geoJsonData = convertToGeoJSON(results.data);
            createStateMarkers(geoJsonData);
          },
          error: (error) => {
            console.error('Error loading state data:', error);
            showError('Failed to load state data. Please try again.');
          }
        });
      }

      // Convert CSV data to GeoJSON format
      function convertToGeoJSON(data) {
        return {
          type: 'FeatureCollection',
          features: data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };
      }

      // Create state markers from GeoJSON data
      function createStateMarkers(geoJsonData) {
        const maxTotalIdps = Math.max(...geoJsonData.features.map(f => f.properties.total_idps));

        L.geoJSON(geoJsonData, {
          pointToLayer: (feature, latlng) => {
            const marker = createCircleMarker(
              latlng, 
              feature.properties.total_idps, 
              maxTotalIdps, 
              MARKER_STYLES.state
            );

            // Add click handler for drill-down
            marker.on('click', () => handleStateClick(feature.properties.state));
            
            return marker;
          },
          onEachFeature: (feature, layer) => {
            addPopupAndTooltip(layer, feature.properties, 'state');
          }
        }).addTo(stateMarkersLayer);

        map3.addLayer(stateMarkersLayer);
      }

      // Create a circle marker with animation
      function createCircleMarker(latlng, value, maxValue, style) {
        const normalizedValue = value / maxValue;
        const baseRadius = style.baseRadius + (normalizedValue * (style.maxRadius - style.baseRadius));
        
        const marker = L.circleMarker(latlng, {
          radius: baseRadius,
          fillColor: style.fillColor,
          color: style.color,
          weight: style.weight,
          opacity: style.opacity,
          fillOpacity: style.fillOpacity
        });

        animateCircleMarker(marker, baseRadius);
        return marker;
      }

      // Animate a circle marker
      function animateCircleMarker(marker, baseRadius) {
        new TWEEN.Tween({ radius: baseRadius })
          .to({ radius: baseRadius * 1.5 }, 1000)
          .easing(TWEEN.Easing.Sinusoidal.InOut)
          .yoyo(true)
          .repeat(Infinity)
          .onUpdate(({ radius }) => marker.setRadius(radius))
          .start();
      }

      // Add popup and tooltip to a layer
      function addPopupAndTooltip(layer, properties, level) {
        if (level === 'state') {
          layer.bindPopup(`
            <b>State:</b> ${properties.state}<br/>
            <b>Total IDPs:</b> ${properties.total_idps.toLocaleString()}<br/>
            <small>Click to view districts</small>
          `);

          layer.bindTooltip(`
            <b>${properties.state}</b><br/>
            <b>Total IDPs:</b> ${properties.total_idps.toLocaleString()}
          `);
        } else {
          layer.bindPopup(`
            <b>District:</b> ${properties.district}<br/>
            <b>Total IDPs:</b> ${properties.total_idps.toLocaleString()}
          `);

          layer.bindTooltip(`
            <b>${properties.district}</b><br/>
            <b>Total IDPs:</b> ${properties.total_idps.toLocaleString()}
          `);
        }
      }

      // Handle state click for drill-down
      function handleStateClick(stateName) {
        map3.removeLayer(stateMarkersLayer);
        loadDistrictData(stateName);
      }

      // Load district data for a state
      function loadDistrictData(stateName) {
        document.getElementById('map-title-3').textContent = `Loading districts for ${stateName}...`;
        
        Papa.parse('./data/districts_data.csv', {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (!results.data || results.data.length === 0) {
              showError('No district data found for this state');
              return;
            }

            const stateDistricts = results.data.filter(d => d.state === stateName);
            createDistrictMarkers(stateDistricts, stateName);
          },
          error: (error) => {
            console.error('Error loading district data:', error);
            showError('Failed to load district data. Please try again.');
            resetToStateView();
          }
        });
      }

      // Create district markers
      function createDistrictMarkers(districts, stateName) {
        districtMarkersLayer.clearLayers();
        const maxTotalIdps = Math.max(...districts.map(d => d.total_idps));

        districts.forEach(district => {
          const marker = createCircleMarker(
            [district.lat, district.lon], 
            district.total_idps, 
            maxTotalIdps, 
            MARKER_STYLES.district
          );

          addPopupAndTooltip(marker, district, 'district');
          districtMarkersLayer.addLayer(marker);
        });

        map3.addLayer(districtMarkersLayer);
        updateUIForDistrictView(stateName, districts);
        currentState = stateName;
      }

      // Update UI for district view
      function updateUIForDistrictView(stateName, districts) {
        document.getElementById('map-title-3').textContent = `IDPs by District in ${stateName}`;
        drilldownBackBtn.style.display = 'block';

        if (districts.length > 0) {
          const bounds = L.latLngBounds(districts.map(d => [d.lat, d.lon]));
          map3.fitBounds(bounds, { padding: MAP_CONFIG.padding });
        }
      }

      // Reset to state view
      function resetToStateView() {
        map3.removeLayer(districtMarkersLayer);
        map3.addLayer(stateMarkersLayer);
        map3.setView(MAP_CONFIG.center, MAP_CONFIG.zoom);
        document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
        drilldownBackBtn.style.display = 'none';
        currentState = null;
      }

      // Show error message
      function showError(message) {
        console.error(message);
        // You could implement a more user-friendly error display here
        alert(message);
      }

      // Add legend to the map
      function addLegend() {
        const legend = L.control({ position: 'bottomright' });
        
        legend.onAdd = () => {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = `
            <span style="font-size:14px; font-weight:bold;">Total IDPs by State:</span><br/>
            <div style="display: flex; align-items: center; margin-top: 10px;">
              <div style="width: 10px; height: 10px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
              <span style="font-size:12px;">  < 500,000 IDPs</span>
            </div>
            <div style="display: flex; align-items: center; margin-top: 5px;">
              <div style="width: 20px; height: 20px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
              <span style="font-size:12px;"> 500,001 - 1,000,000 IDPs</span>
            </div>
            <div style="display: flex; align-items: center; margin-top: 5px;">
              <div style="width: 30px; height: 30px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
              <span style="font-size:12px;"> > 1,000,001 IDPs</span>
            </div>
            <div style="margin-top: 10px; font-size:12px; color: #666;">
              Click on a state to view district-level data
            </div>
          `;
          return div;
        };
        
        legend.addTo(map3);
      }

      // Setup event listeners
      function setupEventListeners() {
        drilldownBackBtn.addEventListener('click', resetToStateView);
      }

      // Start Tween.js animation loop
      function startAnimationLoop() {
        function animate() {
          requestAnimationFrame(animate);
          TWEEN.update();
        }
        animate();
      }

      // Initialize the map
      initializeMap();
    });
  </script>
</body>
</html>
